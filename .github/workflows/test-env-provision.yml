name: Production Deployment

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Kubernetes Namespace'
        required: true
        default: 'testing'

env:
  AZURE_CONTAINER_REGISTRY: ${{ secrets.AZURE_CONTAINER_REGISTRY }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_STAGING_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
  RESOURCE_GROUP_NAME : deakinuni
  AKS_NAME : s224917579
  NAMESPACE: ${{ github.event.inputs.namespace }}

jobs:
  deploy_to_staging:
    runs-on: ubuntu-latest
    outputs:
      product_api_url: ${{ steps.deploy_product_service.outputs.product_api_url }}
      order_api_url: ${{ steps.deploy_order_service.outputs.order_api_url }}
      customer_api_url: ${{ steps.deploy_customer_service.outputs.customer_api_url }}
      frontend_ip: ${{ steps.get_frontend_ip.outputs.frontend_ip }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ env.AZURE_CREDENTIALS }}

      - name: Azure Login for ACR
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Set AKS credentials
        run: |
          az aks get-credentials --name ${{ env.AKS_NAME }} --resource-group ${{ env.RESOURCE_GROUP_NAME }}

      - name: Create namespace
        if: github.event.inputs.action == 'apply'
        run: |
          kubectl create namespace $NAMESPACE || echo "Namespace already exists"

      - name: Create Kubernetes Secret (Azure + Postgres)
        if: github.event.inputs.action == 'apply'
        env:
          STORAGE_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}
          STORAGE_KEY: ${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}
        run: |
          echo "Creating Kubernetes secret for Storage and DB"
          kubectl create secret generic ecomm-secrets-w08e1 \
            --from-literal=POSTGRES_USER=postgres \
            --from-literal=POSTGRES_PASSWORD=postgres \
            --from-literal=AZURE_STORAGE_ACCOUNT_NAME=$STORAGE_NAME \
            --from-literal=AZURE_STORAGE_ACCOUNT_KEY=$STORAGE_KEY \
            -n $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Backend Infrastructure (Namespace, ConfigMaps, Secrets, Databases)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "Deploying backend infrastructure..."
          cd k8s/
          kubectl apply -f configmaps.yaml -n $NAMESPACE 
          kubectl apply -f product-db.yaml -n $NAMESPACE 
          kubectl apply -f order-db.yaml -n $NAMESPACE 

      - name: Deploy to the test environment
        if: github.event.inputs.action == 'apply'
        run: |
          echo "Deploying backend microservices..."
          cd k8s/
          kubectl apply -f product-service.yaml -n $NAMESPACE 
          kubectl apply -f order-service.yaml -n $NAMESPACE 
          kubectl apply -f frontend.yaml -n $NAMESPACE 

      - name: Deployment status
        run: |
          echo "Production deployment is done"
      
      - name: Delete test namespace
        if: github.event.inputs.action == 'destroy'
        run: |
          kubectl delete namespace -n $NAMESPACE 
